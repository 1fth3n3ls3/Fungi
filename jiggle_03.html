<!DOCTYPE html><html><head><title></title></head><script type="module">
import App, { AppBuilder }		from "./fungi/engine/App.js";
import Maths, { Vec3, Quat }	from "./fungi/maths/Maths.js";
import Spring					from "./fungi/maths/Spring.js";
import Transform				from "./fungi/maths/Transform.js";

import Motion					from "./fungi.test/Motion.js";
import FacedCube				from "./fungi/primitives/FacedCube.js";

import Armature					from "./fungi.armature/Armature.js";
import ArmaturePreview			from "./fungi.armature/ArmaturePreview.js";

//#############################################################################
(function(){new AppBuilder()
	.launch()
	.load_armature()
	.download( dl=>dl.addGrp( "shader", 
		"./fungi/shaders/VecWColor.txt", 
		"./fungi.armature/shaders/ArmaturePreview.txt" ) )
	.load_scene( true, true )
	.add_task( init )
	.render_loop( onDraw )
	.set_camera( 0, 25, 4.0, 0, 0, 0 )
	.build().catch( e=>console.error("error",e) );
})();


//#############################################################################
window.addEventListener("keyup", function(e){
	if(e.keyCode == 32) gRun = !gRun;
	if(e.keyCode == 66) gPause = !gPause;
});


//#############################################################################
let gCube, gMover, gSpring, gArm, gRun = false, gPause = false;

function onDraw(dt, ss){
	/**/
	if(!gPause){
		if( gRun ) gMover( dt );
		gSpring( dt );
	}
	

	App.ecs.sys_run();
}

function init(){
	gCube = FacedCube();
	gCube.Node.setScl( 0.5 );

	//........................
	let e 		= Armature.$( App.$Draw( "Arm" ) ),
		b0 		= e.Armature.add_bone( "b0", 0.6, null );

	Armature.finalize( e );
	ArmaturePreview.$( e, "ArmaturePreview", 2 );

	//........................
	gMover = Motion.sin( gCube, 1.0, [2,0,0] );
	//gMover = Motion.circle( gCube, 1.0, 1 );
	//gMover = Motion.rnd_radius( gCube, 0.1, 2 );
	//gMover = Motion.axis_sin_rot( gCube, 2, Vec3.FORWARD, 45 );
	//gMover = Motion.noise_pos( gCube, 3, [-2,0,-2], [2,0,2], 0.3 );
	//gMover = Motion.noise_rot( gCube, 5, [-45, -45, -45], [45, 45, 45], 0.25 );

	gArm 	= e;
	gSpring	= SpringPoint();
	
	//........................
	return true;
}

//#############################################################################
function SpringPoint(){
	let offset		= new Vec3( 0, 0.28, 0 );
	let bone_len	= gArm.Armature.bones[0].Bone.length;
	let bone_tail	= new Vec3( 0, bone_len, 0 );

	let vel 		= new Vec3();
	let pos 		= new Vec3();
	let osc_ps 		= Maths.PI_2 * 0.5;
	let damp 		= 0.3;
	let damp_time	= 0.9;
	let damp_ratio	= Math.log( damp ) / ( -osc_ps * damp_time );

	let tran 		= new Transform();

	return ( dt ) => {
		let cpos = gCube.Node.local.pos;

		gArm.Node.isModified = true;
		gArm.Node.local.pos.copy( cpos ).add( offset );  
		gArm.Node
			.get_world_transform( tran, true )
			.add_pos( bone_tail );

		Spring.semi_implicit_euler_vec3( dt, osc_ps, damp_ratio, tran.pos, pos, vel );

		App.debug
			.reset()
			.point( tran.pos, 6 )
			.point( pos, 0 );

		//gPntT.Node.local.pos.copy( pos );
		//gPntT.Node.isModified = true;

		//let t_dir 	= Vec3.sub( target, cpos );
		//let to_dir	= Vec3.sub( pos, cpos );
		//let axis	= Vec3.cross( t_dir, to_dir ).norm();

		//App.debug
		//	.reset()
		//	.line( cpos, Vec3.add( cpos, to_dir ), 0 )
		//	.line( cpos, Vec3.add( cpos, axis), 8 )
		//	.line( cpos, target, 6 )
		//	.point( target, 6 );
	}
}

/*
http://digitalopus.ca/site/pd-controllers/
https://stackoverflow.com/questions/24197182/efficient-quaternion-angular-velocity
https://gafferongames.com/post/physics_in_3d/
https://gafferongames.com/post/spring_physics/
https://burakkanber.com/blog/physics-in-javascript-car-suspension-part-1-spring-mass-damper/
	great exampleS
https://stackoverflow.com/questions/44688112/spring-physics-applied-to-quaternions-using-python
https://forum.unity.com/threads/technique-to-apply-bouncy-breasts-and-hair-physics.62473/
https://twitter.com/minionsart/status/986374665399685121
https://github.com/cheece/JiggleArmature/blob/master/JiggleArmature.py
http://wiki.unity3d.com/index.php/JiggleBone
https://www.khanacademy.org/partner-content/pixar/simulation/hair-simulation-code/v/sim7-fix
	Has Multi Mass Spring Configuration.
https://github.com/skevy/wobble/blob/develop/src/index.ts#L261
https://hackernoon.com/the-spring-factory-4c3d988e7129
	spring with stiffness and underdamping but in a time based way like easing

https://medium.com/unity3danimation/torsional-springs-4c700b9ede32
http://www.euclideanspace.com/physics/kinematics/angularvelocity/
*/
</script><body></body></html>