<!DOCTYPE html><html><head><title></title></head><script type="module">
import App, { AppBuilder, gl, Shader, Material, Components, Entity } from "../fungi/engine/App.js";
import Maths, { Quat, Vec3 } from "../fungi/maths/Maths.js";
import Transform	from "../fungi/maths/Transform.js";

import XhrPromise	from "../fungi.misc/XhrPromise.js";
import FungiGLTF	from "../fungi.misc/FungiGLTF.js";
import Pose			from "./Pose.js";
import HumanRig		from "./HumanRig.js";
import IKTarget		from "./IKTarget.js";


//#############################################################################
(function(){new AppBuilder()
	.launch()
	.load_armature()
	.download( dl=>dl.addGrp( "shader", 
		"../fungi/shaders/VecWColor.txt", 
		//"./fungi/shaders/LowPolyPhong.txt", 
		"../fungi.armature/shaders/ArmaturePreview.txt", 
		"../fungi.armature/shaders/ArmatureSkinPhong.txt", 
	) ) 
	.load_scene( true, true, true )
	.set_camera( -90, 10, 2, 0, 0.3, 0 )
	.add( dl_files )
	//.render_loop( onDraw )
	.render_on_mouse( onDraw )
	.build().catch( (e)=>console.error("error",e) );
})();

//#############################################################################
function onDraw( dt, ss ){ App.ecs.sys_run(); }


//#############################################################################
let gRig, gTarget;
async function dl_files(){
	let mat = Material.clone( "ArmatureSkinPhong", "RexMat" ).opt_blend( true ).update_uniform( "uBaseColor", "b0b0b0aa" );

	/**/
	let dl	= await XhrPromise.get( 
		"../robo_trex.gltf", "json", "../robo_trex.bin", "arraybuffer",
		//"./files/models/vegeta.gltf", "json", "./files/models/vegeta.bin", "arraybuffer"
	);
	let e = FungiGLTF.$debug( "arm_debug", dl[0], dl[1], "Armature", mat );
	//let e = FungiGLTF.$( "mesh", dl[0], dl[1], "VecWColor" );
	//let e = FungiGLTF.$preview( "src_preview", "Armature", dl[0] );

	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	/* Rex */
	gRig = new HumanRig( e )
		.set_hip( "hip" )
		//.set_chain( "tail", ["tail_1","tail_2","tail_3","tail_4","tail_5","tail_6","tail_7"] )
		.set_leg_l( "LeftUpLeg", "LeftKnee", "LeftShin" )
		.set_leg_r( "RightUpLeg", "RightKnee", "RightShin" )
		.gen_tpose();

	/* Vegeta 
	gRig = new HumanRig( e )
		.set_hip( "hip" )
		.set_leg_l( "LeftUpLeg", "LeftLeg" )
		.set_leg_r( "RightUpLeg", "RightLeg" )
		.set_arm_l( "LeftArm", "LeftForeArm" )
		.set_arm_r( "RightArm", "RightForeArm" )
		.set_feet( "LeftFoot", "RightFoot" )
		.gen_tpose();
	*/


	//gRig.set_bone_pos( gRig.hip.idx, new Vec3(0,0,0) ).apply_pose();

	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	/**/
	let pt = new Transform();
	let ct = new Transform();
	Pose.parent_world( gRig.bind_pose, gRig.leg_l.bones[0], pt, ct );
	App.debug.point( pt.pos, 0 ).point( ct.pos, 2 );

	let target_pos = new Vec3( 0.25, 0.1, 0.3 );
	App.debug.point( target_pos, 6 );

	gTarget = new IKTarget();
	gTarget.from_pos( ct.pos, target_pos, Vec3.FORWARD );

	IKTarget.debug( App.debug, gTarget );

	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	gTarget.three_bone( gRig.leg_l, gRig.bind_pose, gRig.pose_a, pt );
	gRig.apply_pose();
	
	return true;
}

</script><body>
</body></html>