<!DOCTYPE html><html><head><title>Fungi</title></head><script type="module">
import gl 			from "./fungi/core/gl.js";
import Vao			from "./fungi/core/Vao.js";
import Shader		from "./fungi/core/Shader.js";
import App			from "./fungi/engine/App.js";
import Gltf			from "./fungi.misc/Gltf.js";

import Xhr	from "./fungi.misc/XhrPromise.js";

import Armature, { ArmatureSystem } from "./fungi.armature/Armature.js";
import ArmaturePreview, { ArmaturePreviewSystem } from "./fungi.armature/ArmaturePreview.js";

//TODO Modified Files Node.setScl, Node.setRot is new func. Node.addChild updated
// Vao.Buffers.fromBin, vao.buildFromBin;

//#############################################################################
App.useArmature = true;
App	.launch( onDraw, true )
	.then( dl=>dl
		.add( "shader", "../fungi/shaders/VecWColor.txt" )
		.add( "shader", "../fungi/shaders/LowPolyPhong.txt" )
		.add( "shader", "./fungi.armature/shaders/ArmaturePreview.txt" )
		.add( "shader", "./fungi.armature/shaders/ArmatureSkin.txt" )
		.add( "shader", "./fungi.armature/shaders/ArmatureSkinPhong.txt" )
		.start()
	)
	.then( ()=> 	App.loadModules( "../../fungi.armature/Armature.js", "../../fungi.armature/ArmaturePreview.js" ) )
	.then( ()=>		App.loadScene() )

	.then( ()=>		Xhr.get( "./Vegeta.gltf", "json", "./Vegeta.bin", "arraybuffer" ) )
	.then( ary=>	LoadModel( ary[0], ary[1]) )
	
	.then( ()=>		init() )
	.catch( err=>	console.error( err ) );


//#############################################################################
function onDraw( dt, ss ){ App.ecs.updateSystems(); }


//#############################################################################
function init(){
	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	App.camera.Node
		.setPos( 0, 1.5, 4 )
		.setRotAxis( [1,0,0], -15 * Math.PI / 180 );


	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	App.loop.start();
}


function LoadModel( json, bin ){
	console.log( "LoadModel", json, bin );

	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	let test = Gltf.getMesh( "Vegeta", json, bin, true );
	//console.log( JSON.stringify( test ) );
	console.log( test );
	

	let primatives = Gltf.getMesh( "Vegeta", json, bin );
	let p = primatives[ 0 ];
	console.log( p );
	
	/*
	let vao = Vao.buildStandard( "Vegeta", p.vertices.compLen, p.vertices.data, 
		(p.normal)?		p.normal.data	: null, 
		(p.uv)? 		p.uv.data		: null,
		(p.indices)?	p.indices.data	: null );
	*/
	
	let vao = Vao.buildSkinning( "Vegeta", p.vertices.compLen, p.vertices.data,
		(p.normal)?		p.normal.data	: null, 
		(p.uv)? 		p.uv.data		: null,
		(p.indices)?	p.indices.data	: null,
		p.joints.data,
		p.weights.data
	);
	//console.log( vao );


	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	//let e = App.$Draw( "Vegeta", vao, "LowPolyPhong", p.mode );
	//let e = App.$Draw( "Vegeta", vao, "ArmatureSkin", p.mode );
	let e = App.$Draw( "Vegeta", vao, "ArmatureSkinPhong", p.mode );
	
	if( p.rotation )	e.Node.setRot( p.rotation );
	if( p.position )	e.Node.setPos( p.position );
	if( p.scale ) 		e.Node.setScl( p.scale );


	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	let bones = Gltf.getSkin( "Armature", json );
	Armature.$( e );

	loadBones( e, bones );

	ArmaturePreview.$( e, "ArmaturePreview" );

	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	let b = Armature.getBone( e.Armature, "Neck" );

	b.Node.local.rot.setAxisAngle( [1,0,0], -45 * Math.PI / 180 );
	b.Node.isModified = true;
	e.Armature.isModified = true;

	b = Armature.getBone( e.Armature, "LeftArm" );
	b.Node.local.rot.setAxisAngle( [1,0,0], 65 * Math.PI / 180 );
	b.Node.isModified = true;

	b = Armature.getBone( e.Armature, "RightArm" );
	b.Node.local.rot.setAxisAngle( [1,0,0], 65 * Math.PI / 180 );
	b.Node.isModified = true;

	//console.log( b );
	//console.log( JSON.stringify( Armature.serialize( e.Armature ) ) );
}

function loadBones( e, bones ){
	let arm = e.Armature;	

	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	// Create Bones
	let i, b, ab, bLen = bones.length;
	for( i=0; i < bLen; i++ ){
		b	= bones[i];
		ab	= Armature.addBone( arm, b.name, 1, null, b.idx );

		if( b.rot ) ab.Node.setRot( b.rot );
		if( b.pos ) ab.Node.setPos( b.pos );
		if( b.scl ) ab.Node.setScl( b.scl );
	}

	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	// Setting up Parent-Child
	for( i=0; i < bLen; i++ ){
		b	= bones[ i ];
		ab	= arm.bones[ b.idx ];

		// Can not have levels updated automaticly, Callstack limits get hit
		// Instead, using the Level from bones to manually set it.
		if( b.p_idx != null ) App.node.addChild( arm.bones[ b.p_idx ], ab, false );

		// Manual set node level, Must do it after addChild, else it will get overwritten.
		ab.Node.level = b.lvl; 
	}
	Armature.finalize( e );	//This updates World Transforms

	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	// With the WorldTransforms update, Calculate the Length of each bone.
	for( i=0; i < bLen; i++ ){
		ab	= arm.bones[ i ];
		if( ab.Node.children.length == 0 ){
			ab.Bone.length = 0.03;
			continue;
		}

		b = ab.Node.children[0].Node.world;					// First Child's World Space Transform
		ab.Bone.length = ab.Node.world.pos.length( b.pos );	// Distance from Parent to Child
	}
}

</script><body></body></html>