<!DOCTYPE html><html><head><title></title></head><script type="module">
import App, { AppBuilder }		from "./fungi/engine/App.js";
import Maths, { Vec3, Quat }	from "./fungi/maths/Maths.js";
import Spring					from "./fungi/maths/Spring.js";
import Transform				from "./fungi/maths/Transform.js";

import Motion					from "./fungi.test/Motion.js";
import FacedCube				from "./fungi/primitives/FacedCube.js";

import Armature					from "./fungi.armature/Armature.js";
import ArmaturePreview			from "./fungi.armature/ArmaturePreview.js";

import Jiggly, { JigglySystem }	from "./fungi.armature/Jiggly.js";

//#############################################################################
(function(){new AppBuilder()
	.launch()
	.load_armature()
	.download( dl=>dl.addGrp( "shader", 
		"./fungi/shaders/VecWColor.txt", 
		"./fungi.armature/shaders/ArmaturePreview.txt" ) )
	.load_scene( true, true )
	.add_task( init )
	.render_loop( onDraw )
	.set_camera( 0, 25, 4.0, 0, 0, 0 )
	.build().catch( e=>console.error("error",e) );
})();


//#############################################################################
window.addEventListener("keyup", function(e){
	if(e.keyCode == 32) gRun	= !gRun;
	if(e.keyCode == 66) gPause	= !gPause;
});


//#############################################################################
let gCube, gMover, gSpring, gArm, gRun = false, gPause = false;

function onDraw(dt, ss){
	/* */
	if(!gPause){
		if( gRun ) gMover( dt );
		//gSpring( dt );
	}
	

	App.ecs.sys_run();
}

function init(){
	JigglySystem.init( App.ecs );

	//........................
	let e 		= Armature.$( App.$Draw( "Arm", FacedCube.vao(0.5,0.5,0.5), "VecWColor" ) ),
		b0 		= e.Armature.add_bone( "b0", 0.6 );

	b0.Node.local.pos.y = 0.28;

	Armature.finalize( e );
	ArmaturePreview.$( e, "ArmaturePreview", 2 );

	Jiggly.$( b0, 0.3, 0.9, 0.5 );
	

	let cube = App.$Draw( "TestCube", FacedCube.vao(), "VecWColor" );
	cube.Node.setScl( 0.5 );

	b0.Node.add_child( cube );
	

	//........................
	//gMover = Motion.sin( e, 1.0, [2,0,0] );
	gMover = Motion.circle( e, 1.0, 1 );
	//gMover = Motion.rnd_radius( e, 0.1, 2 );
	//gMover = Motion.axis_sin_rot( e, 2, Vec3.FORWARD, 45 );
	//gMover = Motion.noise_pos( e, 3, [-2,0,-2], [2,0,2], 0.3 );
	//gMover = Motion.noise_rot( e, 5, [-45, -45, -45], [45, 45, 45], 0.25 );

	gArm 	= e;
	//gSpring	= SpringPoint();

	//gSpring( 0.001 );
	
	//........................
	return true;
}

//#############################################################################
function SpringPoint(){
	let bone 		= gArm.Armature.bones[0];
	let bone_tail	= new Vec3( 0, bone.Bone.length, 0 );

	let vel 		= new Vec3();
	let pos 		= new Vec3();
	let osc_ps 		= Maths.PI_2 * 0.5;
	let damp 		= 0.3;
	let damp_time	= 0.9;
	let damp_ratio	= Math.log( damp ) / ( -osc_ps * damp_time );

	let wp 			= new Transform();
	let wc 			= new Transform();
	//let bhead 		= new Vec3();
	//let btail 		= new Vec3();

	// Get Starting Position for the spring position.
	wp.copy( gArm.Node.local )
		.add( bone.Node.local )
		.add_pos( bone_tail );
	pos.copy( wp.pos );

	return ( dt ) => {
		//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		wp.copy( gArm.Node.local );
		wc.copy( gArm.Node.local ).add( bone.Bone.bind );

		let tpos = wc.transformVec( bone_tail, new Vec3() ); // Tail

		//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		// Apply Spring Movement
		Spring.semi_implicit_euler_vec3( dt, osc_ps, damp_ratio, tpos, pos, vel );

		//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		// Need to get the Two Rays from the Origin of the Bone Head's Position
		let ray_a	= new Vec3().from_sub( tpos, wc.pos ).norm();
		let ray_b	= new Vec3().from_sub( pos, wc.pos ).norm();

		// Get the Axis and Angle of Rotation.
		/*
		let ray_c	= Vec3.cross( ray_a, ray_b ).norm();
		let rad		= Vec3.angle( ray_a, ray_b );
		let q 		= Quat.axisAngle( ray_c, rad );
		*/

		let q = Quat.rotationTo( ray_a, ray_b );
		
		q.mul( wc.rot ).pmul( wp.rot.invert() )
		bone.Node.setRot( q );
		gArm.Armature.isModified = true;

		//console.log( Vec3.dot( ray_a, ray_b ) );
		//console.log( Vec3.dot( ray_a, ray_b ) );

		//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		/**/
		App.debug.reset()
			.point( wc.pos, 6 )
			.point( tpos, 2 )
			.point( pos, 0 )
			;
	}
}

/*
http://digitalopus.ca/site/pd-controllers/
https://stackoverflow.com/questions/24197182/efficient-quaternion-angular-velocity
https://gafferongames.com/post/physics_in_3d/
https://gafferongames.com/post/spring_physics/
https://burakkanber.com/blog/physics-in-javascript-car-suspension-part-1-spring-mass-damper/
	great exampleS
https://stackoverflow.com/questions/44688112/spring-physics-applied-to-quaternions-using-python
https://forum.unity.com/threads/technique-to-apply-bouncy-breasts-and-hair-physics.62473/
https://twitter.com/minionsart/status/986374665399685121
https://github.com/cheece/JiggleArmature/blob/master/JiggleArmature.py
http://wiki.unity3d.com/index.php/JiggleBone
https://www.khanacademy.org/partner-content/pixar/simulation/hair-simulation-code/v/sim7-fix
	Has Multi Mass Spring Configuration.
https://github.com/skevy/wobble/blob/develop/src/index.ts#L261
https://hackernoon.com/the-spring-factory-4c3d988e7129
	spring with stiffness and underdamping but in a time based way like easing

https://medium.com/unity3danimation/torsional-springs-4c700b9ede32
http://www.euclideanspace.com/physics/kinematics/angularvelocity/
*/
</script><body></body></html>