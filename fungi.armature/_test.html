<!DOCTYPE html><html><head><title>Fungi</title></head><script type="module">
import App			from "../fungi/engine/App.js";
import Geometry		from "../fungi.misc/Geometry.js";

import Armature, { ArmatureSystem } from "./Armature.js";
import ArmaturePreview, { ArmaturePreviewSystem } from "./ArmaturePreview.js";

//#############################################################################
App.useArmature = true;
App.launch( onDraw, [
	{ type:"shader", file:"../fungi/shaders/VecWColor.txt" },
	{ type:"shader", file:"../fungi/shaders/BaseColor.txt" },
	{ type:"shader", file:"./shaders/ArmaturePreview.txt" },
	{ type:"shader", file:"./shaders/ArmatureSkin.txt" },
])	.then( ()=>App.loadScene( false ) )
	.then( ()=>init() )
	.catch( (err)=>console.error( err ) );


//#############################################################################
function onDraw( dt, ss ){

	/*
	let be = Armature.getBone( gEntity, "b1" );
	be.Node.local.rot.setAxisAngle( [0,0,1], Math.sin( ss*1.4 ) * 40 * Math.PI / 180 );
	be.Node.isModified = true;	
	gEntity.Armature.isModified = true;
	*/

	App.ecs.updateSystems();
}


//#############################################################################
let gEntity;
function init(){
	App.camera.Node
		.setPos( 0, 1.5, 4 )
		.setRotAxis( [1,0,0], -15 * Math.PI / 180 );

	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	let e 		= Armature.$( App.$Draw( "Arm" ) );
	let arm		= e.Armature;
	gEntity = e;

	let b0 = Armature.addBone( arm, "b0", 0.4, null );
	let b1 = Armature.addBone( arm, "b1", 0.4, b0 );
	let b2 = Armature.addBone( arm, "b2", 0.4, b1 );
	Armature.finalize( e );
	ArmatureSystem.init( App.ecs );

	b1.Node.local.rot.rz( 45 * Math.PI / 180 );
	b0.Node.local.rot.rz( 45 * Math.PI / 180 );
	b2.Node.local.rot.rz( 45 * Math.PI / 180 );

	ArmaturePreview.$( e, "ArmaturePreview" ); // VecWColor
	ArmaturePreviewSystem.init( App.ecs );

	//b1.Node.local.rot.rz( 45 * Math.PI / 180 );

	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	buildShape();


	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	App.loop.start();
}


//#############################################################################
function buildShape(){
	let geo		= new Geometry(),
		idxAry	= [ 0, 1, 2, 3 ];

	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	geo.addVerts( 
		-0.2, 0,  0.2,   0.2, 0,  0.2,
		 0.2, 0, -0.2,  -0.2, 0, -0.2
	);

	const cnt = 7;
	const inc = 0.2;
	for(var i=1; i < cnt; i++) geo.extrude( idxAry, [ 0, inc * i, 0 ] );

	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	for(var i=0; i < 4; i++) geo.verts[i].initJoints( 0, 1 ).initJointWeights( 1, 0 );
	for(var i=4; i < 8; i++) geo.verts[i].initJoints( 0, 1 ).initJointWeights( 0.5, 0.5 );
	for(var i=8; i < 12; i++) geo.verts[i].initJoints( 1, 2 ).initJointWeights( 1, 0 );
	for(var i=12; i < 16; i++) geo.verts[i].initJoints( 1, 2 ).initJointWeights( 0.5, 0.5 );
	for(var i=16; i < 20; i++) geo.verts[i].initJoints( 2, 0 ).initJointWeights( 1, 0 );
	for(var i=20; i < 24; i++) geo.verts[i].initJoints( 2, 0 ).initJointWeights( 1, 0 );
	for(var i=24; i < 28; i++) geo.verts[i].initJoints( 2, 0 ).initJointWeights( 1, 0 );

	//console.log( geo.weightArray(2) );
	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	let v = geo.buildVao( "skinTest", false, 2 );
	//console.log( v.buf );
	gEntity.Draw.add( v, "ArmatureSkin", 3 ); //BaseColorBlack
}


</script><body></body></html>